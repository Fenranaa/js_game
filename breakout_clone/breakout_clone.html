<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <script src="./utils.js"></script>
    <script src="./game.js"></script>
    <script src="./block.js"></script>
    <script src="./ball.js"></script>
    <script src="./paddle.js"></script>
    <script src="./level.js"></script>
    <style>
      canvas {
        margin: 20px 300px;
        border: 1px solid red;
      }
    </style>
    <title>打砖块</title>
  </head>
  <body>
    <canvas id="id-canvas" width="400" height="300"> </canvas>
    <br />
    <input type="range" value="1" id="id-input-speed" />
  </body>
  <script>
    loadLevel = function(n) {
      n = n - 1;
      var level = levels[n];
      var blocks = [];
      for (var i = 0; i < level.length; i++) {
        var p = level[i];
        var block = Block(p);
        blocks.push(block);
      }
      return blocks;
    };
    var blocks = [];
    var pause = false;
    enableDebug = function(pause1) {
      if (!pause1) {
        return;
      }

      window.addEventListener("keydown", event => {
        if (event.key == "q") {
          pause = !pause;
        } else if ("123456".includes(event.key)) {
          blocks = loadLevel(event.key);
        }
      });

      var debugSpeed = document.querySelector("#id-input-speed")
      debugSpeed.addEventListener("input", event => {
        window.fps = Number(event.target.value)
      })
    };
    var main = function() {
      var leftDown = false;
      var rightDown = false;
      var game = Game(60);
      var paddle = Paddle();
      var ball = Ball();
      blocks = loadLevel(1);

      enableDebug(true);

      game.registerAction("a", function() {
        paddle.moveLeft();
      });

      game.registerAction("d", function() {
        paddle.moveRight();
      });

      game.registerAction("f", function() {
        ball.fire();
      });

      game.update = function() {
        if (pause) {
          return;
        }
        //球的移动
        ball.move();
        //判断挡板和球是否相撞
        if (paddle.collide(ball)) {
          ball.bounce();
        }

        for (var i = 0; i < blocks.length; i++) {
          //判断球和砖块相撞
          // if (blocks[i].alive && blocks[i].collide(ball)) {
          //   blocks[i].kill();
          //   ball.bounce();
          // }
          var block = blocks[i];
          if (block.alive && block.collide(ball)) {
            block.kill();
            ball.bounce();
          }
        }
      };

      game.draw = function() {
        // game.context.drawImage(paddle.image, paddle.x, paddle.y);
        // game.context.drawImage(ball.image, ball.x, ball.y);
        game.drawImage(paddle);
        game.drawImage(ball);

        for (var i = 0; i < blocks.length; i++) {
          block = blocks[i];
          if (block.alive) {
            game.drawImage(block);
          }
        }
      };
    };

    main();
  </script>
</html>
