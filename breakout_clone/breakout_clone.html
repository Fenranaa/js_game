<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <style>
      canvas {
        margin: 20px auto;
        border: 1px solid red;
      }
    </style>
    <title>打砖块</title>
  </head>
  <body>
    <canvas id="id-canvas" width="400" height="300"> </canvas>
  </body>
  <script>
    var log = console.log.bind(console);

    var imageFromPath = function(path) {
      var img = new Image();
      img.src = path;
      return img;
    };

    var Paddle = function() {
      var image = imageFromPath("./images/paddle.png");
      var o = {
        image: image,
        x: 160,
        y: 260,
        speed: 5,
        moveLeft: function() {
          this.x -= this.speed;
        },
        moveRight: function() {
          this.x += this.speed;
        }
      };
      //碰撞检测
      o.collide = function(ball) {
        if (
          Math.abs(ball.x - o.x) < o.image.width / 2 + ball.image.width / 2 &&
          Math.abs(ball.y - o.y) < ball.image.height / 2 + o.image.height / 2
        ) {
          log("发生碰撞");
          return true
        }
        return false
      };
      return o;
    };

    var Ball = function() {
      var image = imageFromPath("./images/ball.png");
      var o = {
        image: image,
        x: 120,
        y: 200,
        speedX: 5,
        speedy: 5,
        fired: false,
        fire: function() {
          this.fired = true;
        }
      };
      o.move = function() {
        if (o.fired) {
          log(o.x);
          if (o.x <= 0 || o.x + 17 > 400) {
            o.speedX = -o.speedX;
          }

          if (o.y <= 0 || o.y >= 300) {
            o.speedy = -o.speedy;
          }

          o.x += o.speedX;
          o.y += o.speedy;
        }

        //反弹
        o.bounce = function() {
          o.speedy = -o.speedy;
        };
      };
      return o;
    };

    var Game = function() {
      var g = {
        actions: {},
        keydowns: {}
      };
      var canvas = document.querySelector("#id-canvas");
      var context = canvas.getContext("2d");
      g.canvas = canvas;
      g.context = context;

      window.addEventListener("keydown", event => {
        g.keydowns[event.key] = true;
      });

      window.addEventListener("keyup", event => {
        g.keydowns[event.key] = false;
      });

      g.registerAction = function(key, callback) {
        g.actions[key] = callback;
      };

      setInterval(() => {
        // log(g.keydowns);
        //监听事件
        var actions = Object.keys(g.actions);
        for (var i = 0; i < actions.length; i++) {
          var key = actions[i];
          if (g.keydowns[key]) {
            g.actions[key]();
          }
        }
        g.update();
        context.clearRect(0, 0, canvas.width, canvas.height);
        g.draw();
      }, 1000 / 60);
      return g;
    };

    var main = function() {
      var leftDown = false;
      var rightDown = false;
      var game = Game();
      var paddle = Paddle();
      var ball = Ball();

      game.registerAction("a", function() {
        paddle.moveLeft();
      });

      game.registerAction("d", function() {
        paddle.moveRight();
      });

      game.registerAction("f", function() {
        ball.fire();
      });

      game.update = function() {
        //球的移动
        ball.move();
        //判断挡板和球是否相撞
        if (paddle.collide(ball)) {
          ball.bounce();
        }
      };

      game.draw = function() {
        game.context.drawImage(paddle.image, paddle.x, paddle.y);
        game.context.drawImage(ball.image, ball.x, ball.y);
      };
    };

    main();
  </script>
</html>
